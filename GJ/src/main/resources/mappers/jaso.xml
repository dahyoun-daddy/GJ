<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.gj.mappers.jaso">
	<sql id="searchText">
		<where>
  			<choose>
  				<when test="10 == searchDiv">
  					hr.u_id LIKE '%'||#{searchWord}||'%'
  				</when>
  				<when test="20 == searchDiv">
  					hr.name LIKE '%'||#{searchWord}||'%'
  				</when>
  				<when test="30 == searchDiv"> 
  					hr.email LIKE '%'||#{searchWord}||'%'
  				</when>
  				<otherwise>
  				</otherwise>
  			</choose>
  		</where>
	</sql>

	<select id="doRetrieve" parameterType="SearchVO" resultType="JasoVO">
		SELECT A.*,B.user_nick
		  FROM
		    (
		        SELECT X.*, Y.*
				  FROM
				(
				    SELECT T.cl_no,
				           T.cl_title,
				           T.cl_sungjang,
				           T.cl_sang,
				           T.cl_jangdan,
				           T.cl_jiwon,
				           T.cl_check,
				           T.reg_id,
				           T.reg_dt,
				           T.rnum AS no
				      FROM
				    (
				        SELECT C.*,
				               ROW_NUMBER() OVER(ORDER BY reg_dt DESC) AS rnum
				          FROM usercl C
		                <include refid="searchText"/>
				    ) T
		            WHERE rnum BETWEEN (#{pageSize} * (#{pageNum}-1)+1)
					   AND (#{pageSize} * (#{pageNum}-1)+ #{pageSize})
				) X
				NATURAL JOIN
				(
				    SELECT COUNT(*) AS total_cnt
				      FROM usercl
		            <include refid="searchText"/>
				) Y
		    ) A,
		    (
		        SELECT user_id
		              ,user_nick
		          FROM users
		    ) B
		WHERE A.reg_id = B.user_id
	</select>
	
	<select id="select" parameterType="JasoVO" resultType="JasoVO">
		SELECT cl_no,
			 	cl_title,
		    	cl_sungjang,
		    	cl_sang,
		    	cl_jangdan,
		    	cl_jiwon,
		    	cl_check
		  FROM UserCl
		WHERE cl_no = #{clNo};
	</select>
	
	<delete id="delete" parameterType="JasoVO">
		DELETE FROM usercl
		WHERE cl_no = #{clNo};
	</delete>
	
	<insert id="add" parameterType="JasoVO">
		INSERT INTO usercl (
		    cl_no,
		    cl_title,
		    cl_sungjang,
		    cl_sang,
		    cl_jangdan,
		    cl_jiwon,
		    cl_check,
		    reg_id,
		    reg_dt
		) VALUES (
		    #{clNo},
		    #{clTitle},
		    #{clSungjang},
		    #{clSang},
		    #{clJangdan},
		    #{clJiwon},
		    #{clCheck},
		    #{regId},
		    sysdate
		);
	</insert>
	
	<update id="update" parameterType="JasoVO">
		UPDATE usercl
		SET
		    cl_title = #{clTitle},
		    cl_sungjang = #{clSungjang},
		    cl_sang = #{clSang},
		    cl_jangdan = #{clJangdan},
		    cl_jiwon = #{clJiwon},
		    cl_check = #{clCheck},
		    mod_id = #{modId},
		    mod_dt = sysdate
		WHERE
		    cl_no = #{clNo};
	</update>
</mapper>